import os
import pandas as pd

from collections import defaultdict

tr = pd.read_csv('training-set.csv', names=['file', 'label'], header=None)
tr = tr.set_index(['file'])
tr = tr.to_dict()['label']

logs = os.listdir('query_log/')
i = 1
device_count = defaultdict()
product_count = defaultdict()

file_in_device = set()
file_in_product = set()

for log in logs:

    print('- reading: ', log)
    
    with open('query_log/' + log, 'r') as file:
        for line in file:
            line = line.rstrip()
            data = line.split(',')
            file_id = data[0]
            device_id = data[1]
            product_id = data[3]
            if device_id not in device_count:
                device_count[device_id] = [0, 0]
            if product_id not in product_count:
                product_count[product_id] = [0, 0]
            
            if file_id in tr:
                if file_id not in file_in_device:
                    file_in_device.add(file_id)
                    file_in_product.add(file_id)
                    device_count[device_id][tr[file_id]] += 1
                    product_count[product_id][tr[file_id]] += 1

print('- generate result')
with open('device_count.tsv', 'w') as file:
    print('device_name', 'num_of_ones', 'num_of_zeros', sep='\t', file=file)
    for name, count in device_count.items():
        print(name, count[1], count[0], sep='\t', file=file)

with open('product_count.tsv', 'w') as file:
    print('product_name', 'num_of_ones', 'num_of_zeros', sep='\t', file=file)
    for name, count in product_count.items():
        print(name, count[1], count[0], sep='\t', file=file)
        